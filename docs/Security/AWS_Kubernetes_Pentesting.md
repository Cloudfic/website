## Kubernetes Pentesting: A Practical Guide Across Cloud Platforms (2025)

### Description/Summary

This document provides minimal guidance for penetration testing Kubernetes environments across AWS (EKS), Azure (AKS), and GCP (GKE). It outlines a process for identifying vulnerabilities and misconfigurations to enhance the security posture of Kubernetes clusters.

### Goals

*   Provide a structured approach to penetration testing Kubernetes environments.
*   Identify common vulnerabilities and misconfigurations.
*   Offer remediation recommendations for identified issues.
*   Support compliance objectives by aligning with security best practices.

### Pre-POC Generic Questions

*   Is this pentest addressing any specific customer issues or compliance requirements?
*   Are there specific requirements or constraints for the pentest (e.g., scope, tools, timeline)?
*   What are the acceptable risk levels and potential impact of identified vulnerabilities?
*   What is the timeframe for completing the pentest and delivering a report?
*   What level of access will be granted for the pentest (e.g., read-only, privileged)?
*   Which cloud provider(s) are being considered (AWS, Azure, GCP)?

### Scenarios

1.  **Reconnaissance:** Gathering information about the target Kubernetes system, including exposed dashboards, accessible APIs, public cloud metadata, Docker registries, and CI/CD tools.
2.  **Scanning and Enumeration:** Probing the Kubernetes cluster using tools like Nmap, Nessus, kube-hunter, and kube-bench to identify running services, misconfigurations, and vulnerabilities.
3.  **Exploitation:** Attempting to exploit identified vulnerabilities, such as weak permissions, exposed secrets, or insecure applications, to gain unauthorized access or escalate privileges.
4.  **Reporting:** Summarizing findings, documenting vulnerabilities, exploits used, access gained, and providing remediation recommendations.

### Results

The results will vary depending on the environment. Examples include:

*   **Official Kubernetes Security Checklist: Access from the workloads to the cloud metadata API is filtered.**

    In the Network security section of the official Kubernetes Security Checklist, one of the bullet points is to ensure the Kubernetes workload does not reach the Cloud metadata API unless required.

    To perform this test, spin a new pod in the cluster, install curl if required, and try to reach the cloud metadata API:

    ````bash
    kubectl run ubuntu -it --rm --image=ubuntu -n default -- bash
    If you don't see a command prompt, try pressing enter.
    root@ubuntu:/# apt update && apt install curl -y
    [...]
    All packages are up to date.
    root@ubuntu:/# TOKEN=`curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600"` \
    && curl -H "X-aws-ec2-metadata-token: $TOKEN" -v http://169.254.169.254/latest/meta-data/
    [...]
    ami-id
    ami-launch-index
    ami-manifest-path
    autoscaling/
    block-device-mapping/
    events/
    hostname
    iam/
    identity-credentials/
    instance-action
    instance-id
    instance-life-cycle
    instance-type
    local-hostname
    local-ipv4
    mac
    metrics/
    network/
    placement/
    profile
    reservation-id
    security-groups
    services/
    * Closing connection 0
    ````

    As we can see, the cloud metadata API is accessible from the Kubernetes workload. To fix this, we can use Network Policies. Be aware that Network Policies are namespaced resources. If the cluster CNI supports it, you can try to mitigate it using a Global Network Policy or other advanced CNI/Network resources.

    Network Policy example:

    ````yaml
    kind: NetworkPolicy
    apiVersion: networking.k8s.io/v1
    metadata:
      name: default-egress
      namespace: default
    spec:
      podSelector: {}
      policyTypes:
      - Egress
      egress:
      - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
            - 169.254.169.254/32 # Cloud Metadata API Address
            - 172.20.0.1/32 # Internal Kubernetes API Address
    ````

*   **Community Kubernetes Security Checklist: All namespaces should have NetworkPolicy**

    In the Network Security section of the Community Kubernetes Security Checklist, we can find the following:

    > All namespaces should have NetworkPolicy. Interactions between namespaces should be limited to NetworkPolicy following least privileges principles (Inspektor Gadget).

    Using the following commands, we can see that we don't have Network Policies to every namespace (or a Global Network Policy):

    ````bash
    kubectl get netpol -A
    NAMESPACE          NAME              POD-SELECTOR     AGE
    calico-apiserver   allow-apiserver   apiserver=true   58d

    kubectl get globalnetworkpolicies.crd.projectcalico.org
    No resources found
    ````

    This is a trick one to address, but the solution is to map all the applications network requirement and create proper Network Policies to address them.

*   **Trivy**

    Trivy can scan Docker images, folders, Kubernetes resources, and other. This example, will show us a summary of possible problems inside the Kubernetes cluster:

    ````bash
    trivy k8s --report summary cluster
    [...]
    ┌────────────────────┬─────────────────────────────────────────────────────────────────┬────────────────────┐
    │     Namespace      │                            Resource                             │  RBAC Assessment   │
    │                    │                                                                 ├────┬───┬───┬───┬───┤
    │                    │                                                                 │ C  │ H │ M │ L │ U │
    ├────────────────────┼─────────────────────────────────────────────────────────────────┼────┼───┼───┼───┼───┤
    │ velero             │ Role/velero-server                                              │ 2  │   │   │   │   │
    ````

    Using this summary, we can dive into specific resources to try to find their problems. Example:

    ````bash
    trivy k8s --namespace=velero --report all all
    [...]
    velero-Role-velero-server-681658409.yaml (rbac)

    Tests: 16 (SUCCESSES: 14, FAILURES: 2, EXCEPTIONS: 0)
    Failures: 2 (UNKNOWN: 0, LOW: 0, MEDIUM: 0, HIGH: 0, CRITICAL: 2)

    CRITICAL: Role permits wildcard verb on wildcard resource
    ═════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════
    Check whether role permits wildcard verb on wildcard resource

    See https://avd.aquasec.com/misconfig/ksv044
    ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
     velero-Role-velero-server-681658409.yaml:39-44
    ─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
      39 ┌     - apiGroups:
      40 │         - '*'
      41 │       resources:
      42 │         - '*'
      43 │       verbs:
      44 └         - '*'
    ─────────────────────────
    ````

    The example above shows us that Velero is able to perform any task (`verbs: ['*']`) to any resource (`resources: ['*']`) regardless of the apiGroup (`apiGroups: ['*']`). Velero is a backup tool, and will likely require access to all the resources in the cluster. Our jobs here is to determine if there are better ways to ensure Velero can perform its job. If no change is required, then we need to bypass this check.

### Post-POC Generic Questions

*   Did the POC work as expected?
    *   Yes.
*   Are there any additional steps before offering it as a solution to customers?
    *   We can try to create our own Security Checklist, but I think we should start with the available ones.
*   Are there enough information to implement/deploy the POC in a production environment?
    *   Yes. There are plenty of options. Although, it is impossible to create a receipe to all environments.
*   How long does it take to deploy the POCed solution?
    *   The bigger the environment, the longer will take to pentest it, and consequently, to offer the client with a report of any kind and address all the problems.
*   What is the plan for supporting and maintaining the solution after production?
    *   N/A.

### Lessons Learned

Pentesting is a complex task and require a high level of knowledge across a variaty of technologies. It is almost impossible to cover all the points using a single approach or tool.

### Costs

*   Are there any licensing costs involved?
    *   Some pentesting tools might require licensing for commercial use. For now, I would start with the OpenSource ones.
*   What was the initial setup cost?
    *   None.
*   What are the expected running costs?
    *   No, except you need to run any resource inside Kubernetes.
*   What should the client plan in terms of maintenance or upkeep costs?
    *   N/A.
*   Are there any supporting costs?
    *   N/A.

### Ability to Self Maintain

N/A.

### Scalability

N/A.

### Training

*   What kind of training will be required for the client's staff?
    *   No training is required unless we want to transfer the knowledge to the client.
*   What would be the cost and time implications of this training?
    *   As already mentioned, this is a broad subject and requires a lot of knowledge. The client staff needs to have a reasonable amount of experience to understand all the subjects.

### Security

*   What security measures are included in the solution?
    *   All the tests and checklists are related to security.
*   How might the solution impact the client's overall IT security posture?
    *   If the client decides to adopt all the security best practices and proposed changes, their environment will become a different one and will require their team to adapt to the new environment.

### Integration

N/A.

### Disaster Recovery and Business Continuity

N/A.

### Customizability

*   How customizable is the solution to meet the unique needs of the client?
    *   It is possible to focus on specific sections, like Networking or Cluster hardening. Also, all the tools have different severity levels that we can choose during the pentesting execution.
*   What would be the cost and time implications of customization?
    *   It depends on the client's requests.

### Data Migration

N/A.

### Guidelines

*   Understand the scope and objectives of the pentest.
*   Obtain explicit permission from the owners of the Kubernetes cluster and cloud provider before starting any pentesting activities.
*   Follow a structured approach, starting with reconnaissance and enumeration, and then moving on to exploitation and reporting.

### Must Do

*   Use a combination of automated tools and manual techniques to identify vulnerabilities.
    *   **Why**: Provides a comprehensive assessment of the security posture.
*   Document all findings and remediation recommendations in a clear and concise report.
    *   **Why**: Facilitates effective communication and remediation efforts.
*   Follow the principle of least privilege when assigning permissions.
    *   **Why**: Minimizes the risk of unauthorized access.

### Should Do

*   Use the official Kubernetes Security Checklist and the community Kubernetes Security Checklist as a starting point.
    *   **Pros**: Provides a comprehensive set of security best practices.
    *   **Cons**: May not be applicable to all environments.
*   Implement a layered security approach, including network policies, pod security policies, and RBAC.
    *   **Pros**: Provides multiple layers of defense against attacks.
    *   **Cons**: Can be complex to configure and manage.

### Could Do

*   Use a commercial pentesting tool or service for a more comprehensive assessment.
    *   **Pros**: Provides access to specialized expertise and advanced tools.
    *   **Cons**: Can be expensive.

### Won't Do

*   Perform unauthorized pentesting activities.
    *   **Why**: Can lead to legal consequences.
*   Disclose sensitive information about the Kubernetes environment.
    *   **Why**: Can increase the risk of attacks.

### Tools and Technology

*   [Nmap](https://nmap.org/): Network scanning tool
*   [Nessus](https://www.tenable.com/products/nessus): Vulnerability scanner
*   [kube-hunter](https://kube-hunter.aquasec.com/): Kubernetes security scanner
*   [kube-bench](https://github.com/aquasecurity/kube-bench): Kubernetes benchmark tool
*   [Trivy](https://github.com/aquasecurity/trivy): Vulnerability scanner for containers and Kubernetes
*   [Official Kubernetes Security Checklist](https://kubernetes.io/docs/concepts/security/security-checklist/)
*   [Community Kubernetes Security Checklist](https://github.com/Vinum-Security/kubernetes-security-checklist)
